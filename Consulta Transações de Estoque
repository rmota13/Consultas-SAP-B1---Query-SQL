SELECT
[T_Main].[ID_Transacao_Estoque],
[T_Main].[Codigo_Item],
[T_ITM].[ItemName] AS [Nome_Item],
[T_Main].[Data_Lancamento],
[T_WHS].[WhsName] AS [Nome_Deposito],
[T_Main].[Quantidade_Entrada],
[T_Main].[Quantidade_Saida],
[T_Main].[Preco],
[T_Main].[Tipo_de_Movimento],
[T_Main].[Nome_Parceiro],
[T_Main].[Numero_Documento_Origem]
FROM
(
SELECT
[T0].[TransNum] AS [ID_Transacao_Estoque],
[T0].[ItemCode] AS [Codigo_Item],
[T0].[DocDate] AS [Data_Lancamento],
[T0].[Warehouse] AS [Codigo_Deposito],
[T0].[InQty] AS [Quantidade_Entrada],
[T0].[OutQty] AS [Quantidade_Saida],
[T0].[Price] AS [Preco],
CASE [T0].[TransType]
WHEN 13 THEN 'Venda (Nota Fiscal de Saída)'
WHEN 14 THEN 'Devolução de Venda'
WHEN 15 THEN 'Entrega de Mercadoria'
WHEN 16 THEN 'Devolução de Mercadoria'
WHEN 18 THEN 'Entrada por Compra (Nota Fiscal de Entrada)'
WHEN 19 THEN 'Devolução de Compra (NC)'
WHEN 20 THEN 'Entrada por Compra (Recebimento)'
WHEN 21 THEN 'Devolução de Compra'
WHEN 59 THEN 'Entrada de Mercadoria (sem compra)'
WHEN 60 THEN 'Saída de Mercadoria (diversa)'
WHEN 67 THEN 'Transferência de Estoque'
WHEN 10000071 THEN 'Ajuste de Estoque (Inventário)'
ELSE 'Outro Movimento'
END AS [Tipo_de_Movimento],
COALESCE([T_INV].[CardName], [T_PCH].[CardName], [T_DLN].[CardName], [T_PDN].[CardName], [T_RIN].[CardName], [T_RPD].[CardName], [T_RPC].[CardName]) AS [Nome_Parceiro],
COALESCE(CAST([T_INV].[DocNum] AS VARCHAR(30)), CAST([T_PCH].[DocNum] AS VARCHAR(30)), CAST([T_DLN].[DocNum] AS VARCHAR(30)), CAST([T_PDN].[DocNum] AS VARCHAR(30)), CAST([T_RIN].[DocNum] AS VARCHAR(30)), CAST([T_RPD].[DocNum] AS VARCHAR(30)), CAST([T_RPC].[DocNum] AS VARCHAR(30))) AS [Numero_Documento_Origem]
FROM [OINM] AS [T0]
LEFT JOIN [OINV] AS [T_INV] ON [T0].[CreatedBy] = [T_INV].[DocEntry] AND [T0].[TransType] = 13
LEFT JOIN [OPCH] AS [T_PCH] ON [T0].[CreatedBy] = [T_PCH].[DocEntry] AND [T0].[TransType] = 18
LEFT JOIN [ODLN] AS [T_DLN] ON [T0].[CreatedBy] = [T_DLN].[DocEntry] AND [T0].[TransType] = 15
LEFT JOIN [OPDN] AS [T_PDN] ON [T0].[CreatedBy] = [T_PDN].[DocEntry] AND [T0].[TransType] = 20
LEFT JOIN [ORIN] AS [T_RIN] ON [T0].[CreatedBy] = [T_RIN].[DocEntry] AND [T0].[TransType] = 14
LEFT JOIN [ORPD] AS [T_RPD] ON [T0].[CreatedBy] = [T_RPD].[DocEntry] AND [T0].[TransType] = 16
LEFT JOIN [ORPC] AS [T_RPC] ON [T0].[CreatedBy] = [T_RPC].[DocEntry] AND [T0].[TransType] IN (19, 21)
) AS [T_Main]
LEFT JOIN [OWHS] AS [T_WHS] ON [T_Main].[Codigo_Deposito] = [T_WHS].[WhsCode]
LEFT JOIN [OITM] AS [T_ITM] ON [T_Main].[Codigo_Item] = [T_ITM].[ItemCode];
